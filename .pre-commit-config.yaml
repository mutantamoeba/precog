# Pre-commit Hooks Configuration
# See https://pre-commit.com for documentation
# Run: pre-commit install (one-time setup)
# Run: pre-commit run --all-files (manual full validation)

default_stages: [pre-commit]
fail_fast: false  # Run all hooks, don't stop at first failure

repos:
  # Local custom hooks (project-specific validation)
  # Layer 1 (Pre-Commit): Fast checks (~2-5s total)
  # Layer 2 (Pre-Push): Thorough validation (~60-90s, includes tests)
  #   See .git/hooks/pre-push for Steps 8-10 (SCD queries, property tests, fixtures)
  - repo: local
    hooks:
      # Documentation validation (10 comprehensive checks - ENHANCED)
      - id: validate-docs
        name: Documentation Validation (10 checks)
        entry: python scripts/validate_docs.py
        language: system
        pass_filenames: false
        files: \.(md|yaml|yml)$
        description: "Validates docs consistency, cross-refs, versioning, phase status, YAML configs, and config sync (Pattern 8)"

      # Code quality: Ruff linter (staged files only)
      - id: ruff-check
        name: Ruff Linter
        entry: python -m ruff check
        language: system
        pass_filenames: true
        types: [python]
        description: "Runs Ruff linter on staged Python files"

      # Code quality: Ruff formatter (staged files only)
      - id: ruff-format
        name: Ruff Formatter
        entry: python -m ruff format --check
        language: system
        pass_filenames: true
        types: [python]
        description: "Checks code formatting on staged Python files"

      # Type checking: Mypy (with incremental caching)
      # Mypy caches in .mypy_cache/ - first run ~20-30s, subsequent ~5-10s
      - id: mypy
        name: Mypy Type Checking (incremental)
        entry: python -m mypy . --incremental --cache-dir .mypy_cache --exclude 'tests/' --exclude '_archive/' --exclude 'venv/' --exclude '.venv/' --ignore-missing-imports
        language: system
        pass_filenames: false
        types: [python]
        description: "Type checking with mypy (uses .mypy_cache for faster runs)"

      # Security: Hardcoded credentials scan
      - id: security-credentials
        name: Security Scan (Hardcoded Credentials)
        entry: bash
        args:
          - -c
          - |
            # Exclude test files, test data, and obvious placeholders (YOUR_, TEST_, EXAMPLE_)
            if git grep -E '(password|secret|api_key|token)\s*=\s*['\''"][^'\''\"]{5,}['\''"]' -- '*.py' '*.yaml' '*.yml' '*.sql' ':(exclude)tests/**' ':(exclude)test_*.py' | grep -v -E '(YOUR_|TEST_|EXAMPLE_|PLACEHOLDER|<[A-Z_]+>)'; then
              echo "ERROR: Found potential hardcoded credentials!"
              echo "If this is a false positive (test/example value), use placeholders like YOUR_KEY or TEST_VALUE"
              exit 1
            fi
            echo "No hardcoded credentials detected"
        language: system
        pass_filenames: false
        description: "Scans for hardcoded passwords, API keys, tokens, and secrets (excludes tests and placeholders)"

      # DEF-005: No print() in production code (use logger instead)
      - id: no-print-in-production
        name: No print() in Production Code
        entry: bash
        args:
          - -c
          - |
            # Check for print() in production code paths (excludes scripts/, tests/, migrations/)
            # Production paths: src/precog/database/, api_connectors/, trading/, analytics/, utils/, config/
            # Excludes: migrations/ (standalone scripts), tests/ (all test files), docstring examples (>>> print(...))
            staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(database|api_connectors|trading|analytics|utils|config)/.*\.py$' | grep -v 'migrations/' | grep -v 'tests/' || true)
            if [ -n "$staged_files" ]; then
              # Use grep to find print() but exclude docstring examples (lines with >>> or ...)
              if echo "$staged_files" | xargs grep -n 'print(' 2>/dev/null | grep -v -E '(>>>|\.\.\.)' ; then
                echo ""
                echo "ERROR: Found print() statements in production code!"
                echo "Fix: Use logger.info(), logger.debug(), or logger.error() instead"
                echo "Allowed: print() in scripts/, tests/, and migrations/ directories"
                exit 1
              fi
            fi
            echo "No print() statements in production code"
        language: system
        pass_filenames: false
        files: '(database|api_connectors|trading|analytics|utils|config)/.*\.py$'
        exclude: 'migrations/.*\.py$'
        description: "Prevents print() in production code (use structured logging instead)"

      # CODE_REVIEW_TEMPLATE enforcement: Basic REQ traceability
      - id: code-review-basics
        name: Code Review Basics (REQ Traceability)
        entry: bash
        args:
          - -c
          - |
            # Check new Python files have REQ-XXX-NNN references in docstrings/comments
            new_files=$(git diff --cached --name-only --diff-filter=A | grep -E '(database|api_connectors|trading|analytics)/.*\.py$' || true)
            if [ -n "$new_files" ]; then
              missing_req=""
              for file in $new_files; do
                # Check if file has REQ-XXX-NNN pattern
                if ! grep -q 'REQ-[A-Z]\+-[0-9]\+' "$file" 2>/dev/null; then
                  missing_req="$missing_req\n  - $file"
                fi
              done
              if [ -n "$missing_req" ]; then
                echo ""
                echo "[WARN] New files missing REQ-XXX-NNN traceability:"
                echo -e "$missing_req"
                echo ""
                echo "Note: This is a warning (not blocking)"
                echo "Recommendation: Add requirement references to docstrings/comments"
                echo "Reference: CODE_REVIEW_TEMPLATE Section 1 (Requirements Traceability)"
                # Warning only - don't fail
              fi
            fi
            echo "REQ traceability check complete"
        language: system
        pass_filenames: false
        files: '(database|api_connectors|trading|analytics)/.*\.py$'
        description: "Checks new files have requirement traceability (REQ-XXX-NNN)"

      # CLAUDE.md Pattern 1: Decimal precision enforcement
      - id: decimal-precision-check
        name: Decimal Precision Check (Pattern 1)
        entry: bash
        args:
          - -c
          - |
            # Check for float usage in price/probability/financial code
            staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)
            violations=""
            if [ -n "$staged_files" ]; then
              for file in $staged_files; do
                # Look for suspicious float patterns in financial contexts
                # Pattern: variable names containing price/prob/amount/balance = float()
                if grep -n -E '(price|prob|amount|balance|edge|kelly|spread|fee).*=.*float\(' "$file" 2>/dev/null; then
                  violations="$violations\n  - $file: float() used in financial calculation"
                fi
                # Pattern: Column(Float, ...) in database models
                if grep -n 'Column.*Float' "$file" 2>/dev/null | grep -v '#'; then
                  violations="$violations\n  - $file: Column(Float) instead of DECIMAL"
                fi
              done
              if [ -n "$violations" ]; then
                echo ""
                echo "[FAIL] Decimal precision violations (Pattern 1):"
                echo -e "$violations"
                echo ""
                echo "Fix: Use Decimal('0.05') instead of float(0.05)"
                echo "Fix: Use Column(DECIMAL(10,4)) instead of Column(Float)"
                echo "Reference: CLAUDE.md Pattern 1 (Decimal Precision)"
                exit 1
              fi
            fi
            echo "Decimal precision check passed"
        language: system
        pass_filenames: false
        types: [python]
        description: "Enforces Decimal precision for financial calculations (CRITICAL)"

  # Standard pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      # File formatting
      - id: trailing-whitespace
        name: Trim Trailing Whitespace
        description: "Removes trailing whitespace from all files"

      - id: end-of-file-fixer
        name: Fix End of Files
        description: "Ensures files end with a newline"

      - id: mixed-line-ending
        name: Fix Mixed Line Endings
        args: [--fix=lf]
        description: "Normalizes line endings to LF"

      # File checks
      - id: check-added-large-files
        name: Check Large Files
        args: [--maxkb=1000]
        description: "Prevents large files (>1MB) from being committed"

      - id: check-case-conflict
        name: Check Case Conflicts
        description: "Checks for files that would conflict in case-insensitive filesystems"

      - id: check-merge-conflict
        name: Check Merge Conflicts
        description: "Checks for unresolved merge conflict markers"

      # YAML/JSON validation
      - id: check-yaml
        name: Validate YAML Syntax
        exclude: '\.github/workflows/.*\.yml$'  # GitHub Actions YAML can have special syntax
        description: "Validates YAML file syntax"

      - id: check-json
        name: Validate JSON Syntax
        description: "Validates JSON file syntax"

      # Python-specific
      - id: check-ast
        name: Check Python AST
        description: "Validates Python syntax by parsing AST"

      - id: debug-statements
        name: Check Debug Statements
        description: "Detects python debug statements (pdb, ipdb, breakpoint)"

      # Git-specific
      - id: check-symlinks
        name: Check Broken Symlinks
        description: "Checks for broken symbolic links"

# CI/CD integration note:
# These hooks run automatically on `git commit` after running `pre-commit install`.
# To skip hooks temporarily (NOT RECOMMENDED): git commit --no-verify
# To run hooks manually: pre-commit run --all-files
# To update hook versions: pre-commit autoupdate
